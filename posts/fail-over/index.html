<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Active-Passive Load Balancer | The Tech Underbelly</title><meta name=keywords content="keepalived,load-balancer,system-design,hands-on,fail-over,networking"><meta name=description content="Introduction In this post we will setup loadbalancers in High Availability mode. We will be setting up the load balancers in active-passive fail-over configuration.
I will be using haproxy as the load balancer and apache as the web server, but you can try with nginx as well.
In order to setup active-passive configuration we need some process which periodically checks the active load balancer and as soon as it goes down, it should promote the passive one to be active."><meta name=author content><link rel=canonical href=https://abnvanand.github.io/posts/fail-over/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://abnvanand.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://abnvanand.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abnvanand.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://abnvanand.github.io/apple-touch-icon.png><link rel=mask-icon href=https://abnvanand.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Active-Passive Load Balancer"><meta property="og:description" content="Introduction In this post we will setup loadbalancers in High Availability mode. We will be setting up the load balancers in active-passive fail-over configuration.
I will be using haproxy as the load balancer and apache as the web server, but you can try with nginx as well.
In order to setup active-passive configuration we need some process which periodically checks the active load balancer and as soon as it goes down, it should promote the passive one to be active."><meta property="og:type" content="article"><meta property="og:url" content="https://abnvanand.github.io/posts/fail-over/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-02T17:22:57+05:30"><meta property="article:modified_time" content="2023-09-02T17:22:57+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Active-Passive Load Balancer"><meta name=twitter:description content="Introduction In this post we will setup loadbalancers in High Availability mode. We will be setting up the load balancers in active-passive fail-over configuration.
I will be using haproxy as the load balancer and apache as the web server, but you can try with nginx as well.
In order to setup active-passive configuration we need some process which periodically checks the active load balancer and as soon as it goes down, it should promote the passive one to be active."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://abnvanand.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Active-Passive Load Balancer","item":"https://abnvanand.github.io/posts/fail-over/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Active-Passive Load Balancer","name":"Active-Passive Load Balancer","description":"Introduction In this post we will setup loadbalancers in High Availability mode. We will be setting up the load balancers in active-passive fail-over configuration.\nI will be using haproxy as the load balancer and apache as the web server, but you can try with nginx as well.\nIn order to setup active-passive configuration we need some process which periodically checks the active load balancer and as soon as it goes down, it should promote the passive one to be active.","keywords":["keepalived","load-balancer","system-design","hands-on","fail-over","networking"],"articleBody":"Introduction In this post we will setup loadbalancers in High Availability mode. We will be setting up the load balancers in active-passive fail-over configuration.\nI will be using haproxy as the load balancer and apache as the web server, but you can try with nginx as well.\nIn order to setup active-passive configuration we need some process which periodically checks the active load balancer and as soon as it goes down, it should promote the passive one to be active. For this we will be using keepalived.\nPrerequisites In order to proceed, we need 4 machines. All the 4 machines should be in the same network and should have internet access to install the required packages. Out of these 4 machines, 2 are for load balancers(active and passive) and 2 will be our web servers.\nFor this I will be using virtual machines connected via a virtual box NAT network. If you already have machines in hand, please skip to Web server setup section.\nVirtualbox VM setup \u003c— click to expand Virtualbox VM setup Step 1 Go to Network Manager Step 2 Create a new NAT network Step 3 Create a new VM. I will be using ubuntu server. I just grabbed the VM from https://www.linuxvmimages.com/images/ubuntuserver-2204/\nStep 4 Clone the VM to have a total of 4 VMs.\nStep 5 Set NAT network on the 4 VMs Step 6 Boot into the nodes and edit hostnames and note the IP address.\nI have named the load balancer nodes are load-balancer-1 \u0026 load-balancer-2 and the web server nodes as web-server-1 \u0026 web-server-2.\nNote: If cloning the VMs you might see the same IP addressess being assigned to all the clones. This is because of /etc/machine-id file present on the nodes. To solve this problem you can delete the file rm -f /etc/machine-id and recreate it dbus-uuidgen --ensure=/etc/machine-id.\nIf /var/lib/dbus/machine-id also exists as regular file, remove it as well rm /var/lib/dbus/machine-id and recreate it dbus-uuidgen --ensure. This last command implicitly uses /var/lib/dbus/machine-id as the file name and will copy the machine ID from the already-newly-generated /etc/machine-id [[4]].\nFinally you will have 4 different machines in the same network with different IPs Web server setup On both web servers install apache2.\nsudo apt update \u0026\u0026 sudo apt install -y apache2 Next we configure the web server\necho \"Hello from web server 1\" \u003e /var/www/html/index.html Start and enable the web server\nsudo systemctl enable --now apache2 Load balancer setup Install and setup haproxy On both load balancer nodes install haproxy sudo apt update \u0026\u0026 sudo apt install -y haproxy Next we need to add frontend and backend configs to haproxy.\nEdit the config file at /etc/haproxy/haproxy.cfg appending in the following:- frontend mysite bind *:80 option tcplog mode tcp default_backend web-servers backend web-servers mode tcp balance roundrobin option tcp-check server web1 10.0.2.6:80 check fall 3 rise 2 server web2 10.0.2.7:80 check fall 3 rise 2 The HAProxy config on both LB nodes should look like below after you are done. The fall parameter sets how many failed checks are allowed. The rise parameter sets how many passing checks there must be before returning a previously failed server to the rotation. Refer [5] for more health check options.\nRestart and enable the haproxy service sudo systemctl restart haproxy sudo systemctl enable haproxy Right now if we were to visit any of the addresses below on any of these 4 nodes(or any other node in the same network), we should get our HTML page back.\ncurl http://10.0.2.4 # load-balancer-1 curl http://10.0.2.5 # load-balancer-2 curl http://10.0.2.6 # web-server-1 curl http://10.0.2.7 # web-server-2 Next we need to enable failover, i.e., in case one of the load balancer goes down, the web page should still be reachable.\nFor this we will need some process to monitor haproxy on the LB nodes and somehow route the requests via loadbalancer which is alive. This can be done using Virtual Router Redundancy Protocol(VRRP).\nInstall and setup keepalived We will use Keepalived, which is a software implementation of VRRP on Linux.\nBefore setting up keepalived let’s understand the request flow. VRRP uses a virtual IP address (VIP) [6]. A set of routers participate in an election to determine the host that will control that VIP. Only one router (the master) controls the VIP at a time. If the master fails, VRRP provides mechanisms for detecting that failure and quickly failing over to a standby router. The same algorithm can be used for servers as well.\nIn the above topology, lb1 is the master and is responsible for the 10.0.2.100 IP address. If lb1 fails, then lb2 takes over this IP. This is why it is also called floating IP.\nOn both LB nodes install keepalived\nsudo apt update \u0026\u0026 sudo apt install -y keepalived Next we need to configure keepalived. As mentioned before, keepalived needs to monitor haproxy service running on the node, and as soon as it find haproxy is down on the node, it needs to switch the active and the passive LB nodes by moving the virtual IP from MASTER to BACKUP node.\nIn order to check whether LB went down we can check for the status of haproxy. For this we can use kill command with -0 flag. [1]\nman kill ... DESCRIPTION ... If signal is 0, then no actual signal is sent, but error checking is still performed. We can use this to check whether our load balancer is down.\nNext we configure keepalived by creating /etc/keepalived/keepalived.conf with following content on active load balancer\n# Following script will be used to check if haproxy is still running vrrp_script chk_haproxy { script \"killall -0 haproxy\" interval 2 # script check frequency weight 2 # step size for priority increase/decrease } # Create a virtual interface vrrp_instance vif1 { interface enp0s3 # the physical interface to attach to # get correct adapter name using ip addr/ifconfig command on your LB nodes. state MASTER # we will set this to BACKUP on the other machine priority 101 # we will set this to 100 on the other machine virtual_router_id 51 # needs to be the same on MASTER and BACKUP # The virtual ip address shared between the two loadbalancers virtual_ipaddress { 10.0.2.100 } # Use the script above to check if we should fail over track_script { chk_haproxy } } On the passive load-balancer create the file /etc/keepalived/keepalived.conf with following content:-\n# Following script will be used to check if haproxy is still running vrrp_script chk_haproxy { script \"killall -0 haproxy\" interval 2 weight 2 } # Create a virtual interface with same virtual_router_id as MASTER vrrp_instance vif1 { interface enp0s3 state BACKUP priority 100 virtual_router_id 51 # The virtual ip address shared between the two loadbalancers virtual_ipaddress { 10.0.2.100 } # Use the script above to check if we should fail over track_script { chk_haproxy } } Now if you check the enp0s3 interface on master LB node, you will see the floating IP is also assigned to the same interface. Testing Now from one of the webserver nodes try to curl http://10.0.2.100, you should get the web page. Next, stop the haproxy running on master LB, by either stopping the service sudo systemctl stop haproxy or even powering off the node, while trying to get the web page curl http://10.0.2.100 you will notice that the webpage becomes unavailable intermittently but then becomes available again. This is because the BACKUP haproxy gets promoted to MASTER. You can see the floating ip now shows up on the backup load-balancer node. You can even try watching the keepalived service logs on load-balancer-2 for when it gets promoted from BACKUP to MASTER using journalctl -fu keepalived.service\nNext steps Try setting up the two load balancers in active-active mode.\n","wordCount":"1286","inLanguage":"en","datePublished":"2023-09-02T17:22:57+05:30","dateModified":"2023-09-02T17:22:57+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://abnvanand.github.io/posts/fail-over/"},"publisher":{"@type":"Organization","name":"The Tech Underbelly","logo":{"@type":"ImageObject","url":"https://abnvanand.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://abnvanand.github.io/ accesskey=h title="The Tech Underbelly (Alt + H)">The Tech Underbelly</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://abnvanand.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://abnvanand.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://abnvanand.github.io/archives/ title=archives><span>archives</span></a></li><li><a href=https://abnvanand.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Active-Passive Load Balancer</h1><div class=post-meta><span title='2023-09-02 17:22:57 +0530 +0530'>September 2, 2023</span></div></header><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>In this post we will setup loadbalancers in High Availability mode. We will be setting up the load balancers in active-passive fail-over configuration.</p><p>I will be using haproxy as the load balancer and apache as the web server, but you can try with nginx as well.</p><p>In order to setup active-passive configuration we need some process which periodically checks the active load balancer and as soon as it goes down, it should promote the passive one to be active.
For this we will be using <a href=https://www.keepalived.org/>keepalived</a>.</p><h1 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h1><p>In order to proceed, we need 4 machines. All the 4 machines should be in the same network and should have internet access to install the required packages.
Out of these 4 machines, 2 are for load balancers(active and passive) and 2 will be our web servers.</p><p>For this I will be using virtual machines connected via a virtual box NAT network. If you already have machines in hand, please skip to <a href=#web-server-setup>Web server setup</a> section.</p><details><summary>Virtualbox VM setup &lt;&mdash; click to expand</summary><h2 id=virtualbox-vm-setup>Virtualbox VM setup<a hidden class=anchor aria-hidden=true href=#virtualbox-vm-setup>#</a></h2><h3 id=step-1>Step 1<a hidden class=anchor aria-hidden=true href=#step-1>#</a></h3><p>Go to Network Manager
<img loading=lazy src=network-manager.png alt="Alt text"></p><h3 id=step-2>Step 2<a hidden class=anchor aria-hidden=true href=#step-2>#</a></h3><p>Create a new NAT network
<img loading=lazy src=nat-network.png alt="Alt text"></p><h3 id=step-3>Step 3<a hidden class=anchor aria-hidden=true href=#step-3>#</a></h3><p>Create a new VM.
I will be using ubuntu server. I just grabbed the VM from <a href=https://www.linuxvmimages.com/images/ubuntuserver-2204/>https://www.linuxvmimages.com/images/ubuntuserver-2204/</a></p><h3 id=step-4>Step 4<a hidden class=anchor aria-hidden=true href=#step-4>#</a></h3><p>Clone the VM to have a total of 4 VMs.</p><h3 id=step-5>Step 5<a hidden class=anchor aria-hidden=true href=#step-5>#</a></h3><p>Set NAT network on the 4 VMs
<img loading=lazy src=network-changes.png alt="Alt text"></p><h3 id=step-6>Step 6<a hidden class=anchor aria-hidden=true href=#step-6>#</a></h3><p>Boot into the nodes and edit hostnames and note the IP address.<br>I have named the load balancer nodes are load-balancer-1 & load-balancer-2 and the web server nodes as web-server-1 & web-server-2.</p><blockquote><p>Note: If cloning the VMs you might see the same IP addressess being assigned to all the clones. This is because of /etc/machine-id file present on the nodes. To solve this problem you can delete the file <code>rm -f /etc/machine-id</code> and recreate it <code>dbus-uuidgen --ensure=/etc/machine-id</code>.<br>If <code>/var/lib/dbus/machine-id</code> also exists as regular file, remove it as well <code>rm /var/lib/dbus/machine-id</code> and recreate it <code>dbus-uuidgen --ensure</code>. This last command implicitly uses /var/lib/dbus/machine-id as the file name and will copy the machine ID from the already-newly-generated /etc/machine-id [[4]].</p></blockquote><p>Finally you will have 4 different machines in the same network with different IPs
<img loading=lazy src=setup-complete.png alt="Alt text"></p></details><h1 id=web-server-setup>Web server setup<a hidden class=anchor aria-hidden=true href=#web-server-setup>#</a></h1><p>On both web servers install apache2.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install -y apache2
</span></span></code></pre></div><p>Next we configure the web server</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Hello from web server 1&#34;</span> &gt; /var/www/html/index.html
</span></span></code></pre></div><p>Start and enable the web server</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable --now apache2
</span></span></code></pre></div><h1 id=load-balancer-setup>Load balancer setup<a hidden class=anchor aria-hidden=true href=#load-balancer-setup>#</a></h1><h2 id=install-and-setup-haproxy>Install and setup haproxy<a hidden class=anchor aria-hidden=true href=#install-and-setup-haproxy>#</a></h2><ol><li>On both load balancer nodes install haproxy</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install -y haproxy
</span></span></code></pre></div><ol start=2><li>Next we need to add frontend and backend configs to haproxy.<br>Edit the config file at <code>/etc/haproxy/haproxy.cfg</code> appending in the following:-</li></ol><pre tabindex=0><code>frontend mysite
    bind *:80
    option tcplog
    mode tcp
    default_backend web-servers
backend web-servers
    mode tcp
    balance roundrobin
    option tcp-check
    server web1 10.0.2.6:80 check fall 3 rise 2
    server web2 10.0.2.7:80 check fall 3 rise 2
</code></pre><p>The HAProxy config on both LB nodes should look like below after you are done.
<img loading=lazy src=haproxy.cfg.png alt="Alt text"></p><p>The <code>fall</code> parameter sets how many failed checks are allowed.
The <code>rise</code> parameter sets how many passing checks there must be before returning a previously failed server to the rotation.
Refer [<a href=https://www.haproxy.com/blog/how-to-enable-health-checks-in-haproxy title="How to Enable Health Checks in HAProxy">5</a>] for more health check options.</p><ol start=3><li>Restart and enable the haproxy service</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart haproxy
</span></span><span style=display:flex><span>sudo systemctl enable haproxy
</span></span></code></pre></div><p>Right now if we were to visit any of the addresses below on any of these 4 nodes(or any other node in the same network), we should get our HTML page back.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> curl http://10.0.2.4 <span style=color:#75715e># load-balancer-1</span>
</span></span><span style=display:flex><span> curl http://10.0.2.5 <span style=color:#75715e># load-balancer-2</span>
</span></span><span style=display:flex><span> curl http://10.0.2.6 <span style=color:#75715e># web-server-1</span>
</span></span><span style=display:flex><span> curl http://10.0.2.7 <span style=color:#75715e># web-server-2</span>
</span></span></code></pre></div><p><img loading=lazy src=htmlpage.png alt="Alt text"></p><p>Next we need to enable failover, i.e., in case one of the load balancer goes down, the web page should still be reachable.</p><p>For this we will need some process to monitor haproxy on the LB nodes and somehow route the requests via loadbalancer which is alive. This can be done using <a href=https://en.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol>Virtual Router Redundancy Protocol(VRRP)</a>.</p><h2 id=install-and-setup-keepalived>Install and setup keepalived<a hidden class=anchor aria-hidden=true href=#install-and-setup-keepalived>#</a></h2><p>We will use Keepalived, which is a software implementation of VRRP on Linux.</p><p>Before setting up keepalived let&rsquo;s understand the request flow.
<img loading=lazy src=arch.png alt="Alt text"></p><p>VRRP uses a virtual IP address (VIP) [<a href=https://www.redhat.com/sysadmin/ha-cluster-linux title=VRRP>6</a>]. A set of routers participate in an election to determine the host that will control that VIP. Only one router (the master) controls the VIP at a time. If the master fails, VRRP provides mechanisms for detecting that failure and quickly failing over to a standby router.
The same algorithm can be used for servers as well.</p><p>In the above topology, lb1 is the master and is responsible for the <code>10.0.2.100</code> IP address. If lb1 fails, then lb2 takes over this IP. This is why it is also called floating IP.</p><p>On both LB nodes install keepalived</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install -y keepalived
</span></span></code></pre></div><p>Next we need to configure keepalived.
As mentioned before, keepalived needs to monitor haproxy service running on the node, and as soon as it find haproxy is down on the node, it needs to switch the active and the passive LB nodes by moving the virtual IP from MASTER to BACKUP node.</p><p>In order to check whether LB went down we can check for the status of haproxy. For this we can use kill command with <code>-0</code> flag. [<a href=https://serverfault.com/questions/436732/meaning-of-killall-0>1</a>]</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>man kill  
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>       If signal is 0, <span style=color:#66d9ef>then</span> no actual signal is sent, but error checking is still performed.
</span></span></code></pre></div><p>We can use this to check whether our load balancer is down.</p><p>Next we configure keepalived by creating <code>/etc/keepalived/keepalived.conf</code> with following content on active load balancer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#75715e># Following script will be used to check if haproxy is still running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>vrrp_script chk_haproxy {
</span></span><span style=display:flex><span>    script <span style=color:#e6db74>&#34;killall -0 haproxy&#34;</span>
</span></span><span style=display:flex><span>    interval 2              <span style=color:#75715e># script check frequency
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    weight 2                <span style=color:#75715e># step size for priority increase/decrease
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create a virtual interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>vrrp_instance vif1 {
</span></span><span style=display:flex><span>    interface enp0s3        <span style=color:#75715e># the physical interface to attach to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e># get correct adapter name using ip addr/ifconfig command on your LB nodes. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    state MASTER            <span style=color:#75715e># we will set this to BACKUP on the other machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    priority 101            <span style=color:#75715e># we will set this to 100 on the other machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    virtual_router_id 51    <span style=color:#75715e># needs to be the same on MASTER and BACKUP 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The virtual ip address shared between the two loadbalancers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    virtual_ipaddress {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.0.2.100</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use the script above to check if we should fail over
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    track_script {
</span></span><span style=display:flex><span>        chk_haproxy
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>On the passive load-balancer create the file <code>/etc/keepalived/keepalived.conf</code> with following content:-</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#75715e># Following script will be used to check if haproxy is still running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>vrrp_script chk_haproxy {
</span></span><span style=display:flex><span>    script <span style=color:#e6db74>&#34;killall -0 haproxy&#34;</span>
</span></span><span style=display:flex><span>    interval 2
</span></span><span style=display:flex><span>    weight 2    
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create a virtual interface with same virtual_router_id as MASTER
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>vrrp_instance vif1 {
</span></span><span style=display:flex><span>    interface enp0s3
</span></span><span style=display:flex><span>    state BACKUP               
</span></span><span style=display:flex><span>    priority 100               
</span></span><span style=display:flex><span>    virtual_router_id 51       
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># The virtual ip address shared between the two loadbalancers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    virtual_ipaddress {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>10.0.2.100</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use the script above to check if we should fail over
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    track_script {
</span></span><span style=display:flex><span>        chk_haproxy
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now if you check the <code>enp0s3</code> interface on master LB node, you will see the floating IP is also assigned to the same interface.
<img loading=lazy src=floating-ip.png alt="Alt text"></p><h1 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h1><p>Now from one of the webserver nodes try to <code>curl http://10.0.2.100</code>, you should get the web page.
Next, stop the haproxy running on master LB, by either stopping the service <code>sudo systemctl stop haproxy</code> or even powering off the node, while trying to get the web page <code>curl http://10.0.2.100</code> you will notice that the webpage becomes unavailable intermittently but then becomes available again. This is because the BACKUP haproxy gets promoted to MASTER.
You can see the floating ip now shows up on the backup load-balancer node.
You can even try watching the keepalived service logs on load-balancer-2 for when it gets promoted from BACKUP to MASTER using <code>journalctl -fu keepalived.service</code></p><h1 id=next-steps>Next steps<a hidden class=anchor aria-hidden=true href=#next-steps>#</a></h1><p>Try setting up the two load balancers in active-active mode.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://abnvanand.github.io/tags/keepalived/>keepalived</a></li><li><a href=https://abnvanand.github.io/tags/load-balancer/>load-balancer</a></li><li><a href=https://abnvanand.github.io/tags/system-design/>system-design</a></li><li><a href=https://abnvanand.github.io/tags/hands-on/>hands-on</a></li><li><a href=https://abnvanand.github.io/tags/fail-over/>fail-over</a></li><li><a href=https://abnvanand.github.io/tags/networking/>networking</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://abnvanand.github.io/>The Tech Underbelly</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>